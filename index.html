<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar Bookings ‚Äî Digital Notebook</title>
    <meta name="theme-color" content="#A86523">
    <meta name="description" content="Digital notebook for managing calendar bookings and payments">
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiQ2FsZW5kYXIgQm9va2luZ3MgXHUyMDE0IERpZ2l0YWwgTm90ZWJvb2siLCJzaG9ydF9uYW1lIjoiQ2FsZW5kYXIgQm9va2luZ3MiLCJzdGFydF91cmwiOiIuLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNGQ0VGQ0IiLCJ0aGVtZV9jb2xvciI6IiNBODY1MjMiLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCM2FXUjBhRDBpTVRJNElpQm9aV2xuYUhROUlqRXlPQ0lpSUhacFpYZENiM2c5SWpBZ01DQXhNamdnTVRJNElpQm1hV3hzUFNJalFUZzJOVEl6SWlCNGJXeHVjejBpYUhSMGNEb3ZMM2QzZHk1M00yNXZjbWN2TWpBd01DOXpkbWNpUGp4eVpXTjBJSGRwWkhSb1BTSXhNamdpSUdobGFXZG9kRDBpTVRJNElpQm1hV3hzUFNJalJrTkZSa05DSWk4K1BIUmxlSFFnZUQwaU5qUWlJSGs5SWpZMElpQm1hV3hzUFNJalFUZzJOVEl6SWlCbWIyNTBMWE5wZW1VOUlqSTBJaUJtYjI1MExYZGxhV2RvZEQwaVltOXNaQ0krOEorZHV6d3ZkR1Y0ZEQ0OEwzTjJaejQ9Iiwic2l6ZXMiOiIxMjh4MTI4IiwidHlwZSI6ImltYWdlL3N2Zyt4bWwifV19">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }

        .calendar-day {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .calendar-day::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }

        .calendar-day:hover::before {
            left: 100%;
        }

        .calendar-day:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 25px rgba(168, 101, 35, 0.3);
        }

        .has-payment {
            background: linear-gradient(135deg, #A86523 0%, #E9A319 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(168, 101, 35, 0.4);
        }

        .has-payment:hover {
            background: linear-gradient(135deg, #8B5A1F 0%, #D4941A 100%);
            box-shadow: 0 8px 25px rgba(168, 101, 35, 0.6);
        }

        .calendar-grid {
            background: linear-gradient(145deg, #FCEFCB, #FAD59A);
            border-radius: 20px;
            padding: 20px;
            box-shadow: inset 0 2px 4px rgba(168, 101, 35, 0.1);
        }

        .notebook-entry {
            background: #FCEFCB;
            border-left: 4px solid #A86523;
            box-shadow: 0 2px 8px rgba(168, 101, 35, 0.2);
        }

        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-amber-50 to-orange-100 min-h-screen" style="background: linear-gradient(135deg, #FCEFCB 0%, #FAD59A 100%);">
    <header class="bg-white shadow-lg border-b-4" style="border-color: #A86523;">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <button id="menuToggle" class="p-2 rounded-lg hover:bg-gray-100 transition-colors">
                        <div class="w-6 h-6 flex flex-col justify-center items-center">
                            <span class="block w-6 h-0.5 bg-gray-600 mb-1 transition-all"></span>
                            <span class="block w-6 h-0.5 bg-gray-600 mb-1 transition-all"></span>
                            <span class="block w-6 h-0.5 bg-gray-600 transition-all"></span>
                        </div>
                    </button>
                    <h1 class="ml-4 text-2xl font-bold text-gray-800">Calendar Bookings ‚Äî Digital Notebook</h1>
                </div>
                <div class="text-sm text-gray-600" id="currentDate"></div>
            </div>
        </div>
    </header>

    <div id="sideMenu" class="fixed inset-y-0 left-0 z-50 w-80 bg-white shadow-xl transform -translate-x-full transition-transform duration-300">
        <div class="p-6 border-b border-gray-200">
            <h2 class="text-xl font-semibold text-gray-800">Menu</h2>
            <button id="closeMenu" class="absolute top-4 right-4 p-2 rounded-lg hover:bg-gray-100">
                <span class="text-2xl text-gray-600">√ó</span>
            </button>
        </div>
        <div class="p-6 space-y-4">
            <button id="makeEntryBtn" class="w-full text-white font-medium py-3 px-4 rounded-lg transition-colors" style="background: #A86523; hover:background: #8B5A1F;">
                üìù Make Entry
            </button>
            <button id="searchBookingBtn" class="w-full text-white font-medium py-3 px-4 rounded-lg transition-colors" style="background: #2563eb; hover:background: #1d4ed8;">
                üîç Search Booking
            </button>
        </div>
    </div>

    <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2">
                <div class="bg-gradient-to-br from-white rounded-3xl shadow-2xl p-8 border" style="background: linear-gradient(135deg, #ffffff 0%, #FCEFCB 100%); border-color: #FAD59A;">
                    <div class="flex justify-between items-center mb-8">
                        <h2 class="text-3xl font-bold bg-clip-text text-transparent" style="background: linear-gradient(to right, #A86523, #E9A319); -webkit-background-clip: text;" id="monthYear"></h2>
                        <div class="flex space-x-3">
                            <button id="prevMonth" class="p-3 rounded-xl text-white transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105" style="background: linear-gradient(to right, #A86523, #E9A319);">
                                <span class="text-lg">‚Üê</span>
                            </button>
                            <button id="nextMonth" class="p-3 rounded-xl text-white transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105" style="background: linear-gradient(to right, #A86523, #E9A319);">
                                <span class="text-lg">‚Üí</span>
                            </button>
                        </div>
                    </div>

                    <div class="calendar-grid">
                        <div class="grid grid-cols-7 gap-3 mb-6">
                            <div class="text-center font-bold py-3 text-sm uppercase tracking-wider" style="color: #A86523;">Sun</div>
                            <div class="text-center font-bold py-3 text-sm uppercase tracking-wider" style="color: #A86523;">Mon</div>
                            <div class="text-center font-bold py-3 text-sm uppercase tracking-wider" style="color: #A86523;">Tue</div>
                            <div class="text-center font-bold py-3 text-sm uppercase tracking-wider" style="color: #A86523;">Wed</div>
                            <div class="text-center font-bold py-3 text-sm uppercase tracking-wider" style="color: #A86523;">Thu</div>
                            <div class="text-center font-bold py-3 text-sm uppercase tracking-wider" style="color: #A86523;">Fri</div>
                            <div class="text-center font-bold py-3 text-sm uppercase tracking-wider" style="color: #A86523;">Sat</div>
                        </div>
                        <div id="calendarGrid" class="grid grid-cols-7 gap-3"></div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-1 space-y-6">
                <div class="bg-white rounded-2xl shadow-xl p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Payment Summary</h3>
                    <div id="paymentSummary" class="space-y-3"></div>
                </div>

                <div class="bg-white rounded-2xl shadow-xl p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Payment Details</h3>
                    <div id="selectedDate" class="text-sm text-gray-600 mb-4">Select a date to view payments</div>
                    <div id="paymentList" class="space-y-4"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="searchModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-xl font-bold text-gray-800">Search Booking</h3>
                <button id="closeSearchModal" class="absolute top-4 right-4 p-2 rounded-lg hover:bg-gray-100">
                    <span class="text-2xl text-gray-600">√ó</span>
                </button>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Booking Name</label>
                        <input type="text" id="searchBookingName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter booking name">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
                        <input type="tel" id="searchPhoneNumber" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter phone number">
                    </div>
                </div>
                <button id="performSearch" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition-colors mb-6">
                    üîç Search
                </button>
                <div id="searchResults" class="space-y-4"></div>
            </div>
        </div>
    </div>

    <div id="entryModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-xl font-bold text-gray-800">Make New Entry</h3>
                <button id="closeModal" class="absolute top-4 right-4 p-2 rounded-lg hover:bg-gray-100">
                    <span class="text-2xl text-gray-600">√ó</span>
                </button>
            </div>
            <form id="entryForm" class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Booking Name</label>
                    <input type="text" id="bookingName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:border-2" style="--tw-ring-color: #E9A319; focus:border-color: #A86523;" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Payment Mode</label>
                    <select id="paymentMode" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" required>
                        <option value="">Select payment mode</option>
                        <option value="onlinePayment">Online Payment</option>
                        <option value="cash">Cash</option>
                        <option value="cheque">Cheque</option>
                        <option value="bankTransfer">Bank Transfer</option>
                        <option value="cashPayment">Cash Payment</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
                    <input type="tel" id="phoneNumber" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Received by Name</label>
                    <input type="text" id="receivedBy" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Amount Advance</label>
                    <input type="number" id="amountAdvance" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Booking Date</label>
                        <input type="date" id="bookingDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Date of Payment</label>
                        <input type="date" id="dateOfPayment" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Property</label>
                    <input type="text" id="property" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                <div class="flex space-x-4 pt-4">
                    <button type="submit" class="flex-1 text-white font-medium py-2 px-4 rounded-lg transition-colors" style="background: #A86523;">
                        Save Entry
                    </button>
                    <button type="button" id="cancelEntry" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 font-medium py-2 px-4 rounded-lg transition-colors">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Sample data - start with empty array for fresh install
        let payments = [];

        let currentDate = new Date();
        let selectedDate = null;

        // Helper function to format date as DD-MM-YYYY
        function formatDateToDDMMYYYY(dateString) {
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}-${month}-${year}`;
        }

        // Google Sheets configuration
        // This is the URL to your deployed proxy, which in turn calls the Apps Script.
        // Make sure you have deployed your 'index.js' file to this URL.
        const GOOGLE_SHEETS_URL = 'https://gs-proxy-7yiz67r1h-namanamberkar-gmailcoms-projects.vercel.app';

        // Load data from Google Sheets
        async function loadPaymentsFromSheets() {
            try {
                const response = await fetch(GOOGLE_SHEETS_URL + '?action=getPayments', {
                    method: 'GET',
                    mode: 'cors'
                });
                const data = await response.json();
                if (data.success) {
                    payments = data.payments || [];
                    renderCalendar();
                    updatePaymentSummary();
                }
            } catch (error) {
                console.log('Using offline mode - could not connect to Google Sheets');
            }
        }

        // Save payment to Google Sheets
        async function savePaymentToSheets(payment) {
            try {
                const response = await fetch(GOOGLE_SHEETS_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'addPayment',
                        payment: payment
                    })
                });
                const data = await response.json();
                return data.success;
            } catch (error) {
                console.log('Could not save to Google Sheets - working offline');
                return false;
            }
        }

        // Update payment summary by mode
        function updatePaymentSummary() {
            const paymentModes = {};
            let totalAmount = 0;

            payments.forEach(payment => {
                const mode = payment.paymentMode;
                const amount = payment.amountAdvance;

                if (!paymentModes[mode]) {
                    paymentModes[mode] = 0;
                }
                paymentModes[mode] += amount;
                totalAmount += amount;
            });

            const summarySection = document.querySelector('.lg\\:col-span-1 .bg-white.rounded-2xl.shadow-xl.p-6');
            const summaryDiv = document.getElementById('paymentSummary');

            if (Object.keys(paymentModes).length === 0) {
                summarySection.style.display = 'none';
                return;
            }

            summarySection.style.display = 'block';

            const modeLabels = {
                'onlinePayment': 'Online Payment',
                'cash': 'Cash',
                'cheque': 'Cheque',
                'bankTransfer': 'Bank Transfer',
                'cashPayment': 'Cash Payment'
            };

            let summaryHTML = '';
            Object.entries(paymentModes).forEach(([mode, amount]) => {
                const label = modeLabels[mode] || mode;
                summaryHTML += `
                    <div class="flex justify-between items-center p-3 rounded-lg" style="background: #FCEFCB;">
                        <span class="font-medium text-gray-700">${label}</span>
                        <span class="font-bold text-green-600">‚Çπ${amount.toLocaleString()}</span>
                    </div>
                `;
            });

            summaryHTML += `
                <div class="flex justify-between items-center p-3 rounded-lg border-2 border-dashed" style="border-color: #A86523; background: #FAD59A;">
                    <span class="font-bold text-gray-800">Total Amount</span>
                    <span class="font-bold text-lg" style="color: #A86523;">‚Çπ${totalAmount.toLocaleString()}</span>
                </div>
            `;

            summaryDiv.innerHTML = summaryHTML;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateCurrentDate();
            renderCalendar();
            updatePaymentSummary();
            setupEventListeners();

            // Load data from Google Sheets on startup
            loadPaymentsFromSheets();

            // Register service worker for PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('data:application/javascript;base64,c2VsZi5hZGRFdmVudExpc3RlbmVyKCdpbnN0YWxsJywgZnVuY3Rpb24oZXZlbnQpIHsKICBldmVudC53YWl0VW50aWwoc2VsZi5za2lwV2FpdGluZygpKTsKfSk7CgpzZWxmLmFkZEV2ZW50TGlzdGVuZXIoJ2ZldGNoJywgZnVuY3Rpb24oZXZlbnQpIHsKICBldmVudC5yZXNwb25kV2l0aChmZXRjaChldmVudC5yZXF1ZXN0KSk7Cn0pOw==')
                .then(() => console.log('Service Worker registered'))
                .catch(() => console.log('Service Worker registration failed'));
            }
        });

        function updateCurrentDate() {
            const now = new Date();
            document.getElementById('currentDate').textContent = now.toLocaleDateString('en-GB', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function renderCalendar() {
            const monthYear = document.getElementById('monthYear');
            const calendarGrid = document.getElementById('calendarGrid');

            monthYear.textContent = currentDate.toLocaleDateString('en-US', {
                month: 'long',
                year: 'numeric'
            });

            const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());

            calendarGrid.innerHTML = '';

            for (let i = 0; i < 42; i++) {
                const cellDate = new Date(startDate);
                cellDate.setDate(startDate.getDate() + i);

                const isCurrentMonth = cellDate.getMonth() === currentDate.getMonth();
                const isToday = cellDate.toDateString() === new Date().toDateString();

                // Fix timezone issue by creating date string properly
                const cellDateStr = cellDate.getFullYear() + '-' +
                    String(cellDate.getMonth() + 1).padStart(2, '0') + '-' +
                    String(cellDate.getDate()).padStart(2, '0');
                const hasPayment = payments.some(p => p.dateOfPayment === cellDateStr);

                const cell = document.createElement('div');
                cell.className = `calendar-day p-4 text-center rounded-xl cursor-pointer border-2 border-transparent font-semibold ${
                    isCurrentMonth ? 'text-gray-800' : 'text-gray-400'
                } ${isToday ? 'ring-3 ring-opacity-60' : ''} ${
                    hasPayment ? 'has-payment' : 'bg-white shadow-sm hover:shadow-md'
                }`;

                cell.textContent = cellDate.getDate();
                cell.addEventListener('click', () => selectDate(cellDate));

                if (hasPayment) {
                    const indicator = document.createElement('div');
                    indicator.className = 'w-3 h-3 bg-white rounded-full mx-auto mt-2 shadow-lg animate-pulse';
                    cell.appendChild(indicator);
                }

                calendarGrid.appendChild(cell);
            }
        }

        function selectDate(date) {
            selectedDate = date;
            // Fix timezone issue by creating date string properly
            const dateStr = date.getFullYear() + '-' +
                String(date.getMonth() + 1).padStart(2, '0') + '-' +
                String(date.getDate()).padStart(2, '0');
            const dayPayments = payments.filter(p => p.dateOfPayment === dateStr);

            document.getElementById('selectedDate').textContent = date.toLocaleDateString('en-GB', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            const paymentList = document.getElementById('paymentList');

            if (dayPayments.length === 0) {
                paymentList.innerHTML = '<div class="text-gray-500 text-center py-8">No payments on this date</div>';
            } else {
                paymentList.innerHTML = dayPayments.map(payment => `
                    <div class="notebook-entry p-4 rounded-lg fade-in">
                        <div class="flex justify-between items-start mb-3">
                            <h4 class="font-semibold text-gray-800">${payment.bookingName}</h4>
                            <span class="text-sm font-medium text-green-600">‚Çπ${payment.amountAdvance.toLocaleString()}</span>
                        </div>
                        <div class="space-y-2 text-sm text-gray-600">
                            <div><span class="font-medium">Phone:</span> ${payment.phoneNumber}</div>
                            <div><span class="font-medium">Payment Mode:</span> ${payment.paymentMode}</div>
                            <div><span class="font-medium">Received by:</span> ${payment.receivedBy}</div>
                            <div><span class="font-medium">Booking Date:</span> ${formatDateToDDMMYYYY(payment.bookingDate)}</div>
                            <div><span class="font-medium">Property:</span> ${payment.property}</div>
                        </div>
                    </div>
                `).join('');
            }
        }

        function setupEventListeners() {
            // Menu toggle
            document.getElementById('menuToggle').addEventListener('click', () => {
                document.getElementById('sideMenu').classList.remove('-translate-x-full');
                document.getElementById('overlay').classList.remove('hidden');
            });

            document.getElementById('closeMenu').addEventListener('click', closeMenu);
            document.getElementById('overlay').addEventListener('click', closeMenu);

            // Calendar navigation
            document.getElementById('prevMonth').addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                renderCalendar();
            });

            document.getElementById('nextMonth').addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                renderCalendar();
            });

            // Entry modal
            document.getElementById('makeEntryBtn').addEventListener('click', () => {
                closeMenu();
                document.getElementById('entryModal').classList.remove('hidden');
            });

            document.getElementById('closeModal').addEventListener('click', closeEntryModal);
            document.getElementById('cancelEntry').addEventListener('click', closeEntryModal);

            // Search modal
            document.getElementById('searchBookingBtn').addEventListener('click', () => {
                closeMenu();
                document.getElementById('searchModal').classList.remove('hidden');
            });

            document.getElementById('closeSearchModal').addEventListener('click', closeSearchModal);
            document.getElementById('performSearch').addEventListener('click', performSearch);

            // Form submission
            document.getElementById('entryForm').addEventListener('submit', handleFormSubmit);
        }

        function closeMenu() {
            document.getElementById('sideMenu').classList.add('-translate-x-full');
            document.getElementById('overlay').classList.add('hidden');
        }

        function closeEntryModal() {
            document.getElementById('entryModal').classList.add('hidden');
            document.getElementById('entryForm').reset();
        }

        function closeSearchModal() {
            document.getElementById('searchModal').classList.add('hidden');
            document.getElementById('searchBookingName').value = '';
            document.getElementById('searchPhoneNumber').value = '';
            document.getElementById('searchResults').innerHTML = '';
        }

        function performSearch() {
            const searchName = document.getElementById('searchBookingName').value.toLowerCase().trim();
            const searchPhone = document.getElementById('searchPhoneNumber').value.trim();

            if (!searchName && !searchPhone) {
                document.getElementById('searchResults').innerHTML = '<div class="text-red-500 text-center py-4">Please enter a booking name or phone number to search</div>';
                return;
            }

            const matchingPayments = payments.filter(payment => {
                const nameMatch = !searchName || payment.bookingName.toLowerCase().includes(searchName);
                const phoneMatch = !searchPhone || payment.phoneNumber.includes(searchPhone);
                return nameMatch && phoneMatch;
            });

            const resultsDiv = document.getElementById('searchResults');

            if (matchingPayments.length === 0) {
                resultsDiv.innerHTML = '<div class="text-gray-500 text-center py-8">No bookings found matching your search</div>';
                return;
            }

            // Group payments by booking name and phone
            const groupedPayments = {};
            matchingPayments.forEach(payment => {
                const key = `${payment.bookingName}-${payment.phoneNumber}`;
                if (!groupedPayments[key]) {
                    groupedPayments[key] = {
                        bookingName: payment.bookingName,
                        phoneNumber: payment.phoneNumber,
                        payments: [],
                        totalAmount: 0
                    };
                }
                groupedPayments[key].payments.push(payment);
                groupedPayments[key].totalAmount += payment.amountAdvance;
            });

            let resultsHTML = '<h4 class="text-lg font-bold text-gray-800 mb-4">Search Results</h4>';

            Object.values(groupedPayments).forEach(group => {
                resultsHTML += `
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-4 mb-4">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h5 class="font-bold text-gray-800">${group.bookingName}</h5>
                                <p class="text-sm text-gray-600">üìû ${group.phoneNumber}</p>
                            </div>
                            <div class="text-right">
                                <div class="text-lg font-bold text-green-600">‚Çπ${group.totalAmount.toLocaleString()}</div>
                                <div class="text-sm text-gray-500">${group.payments.length} payment${group.payments.length > 1 ? 's' : ''}</div>
                            </div>
                        </div>
                        <div class="space-y-2">
                `;

                group.payments.forEach(payment => {
                    resultsHTML += `
                        <div class="bg-white rounded p-3 text-sm">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-medium">‚Çπ${payment.amountAdvance.toLocaleString()}</span>
                                <span class="text-gray-500">${formatDateToDDMMYYYY(payment.dateOfPayment)}</span>
                            </div>
                            <div class="text-gray-600">
                                <div><span class="font-medium">Property:</span> ${payment.property}</div>
                                <div><span class="font-medium">Payment Mode:</span> ${payment.paymentMode}</div>
                                <div><span class="font-medium">Received by:</span> ${payment.receivedBy}</div>
                            </div>
                        </div>
                    `;
                });

                resultsHTML += `
                        </div>
                    </div>
                `;
            });

            resultsDiv.innerHTML = resultsHTML;
        }

        async function handleFormSubmit(e) {
            e.preventDefault();

            const formData = new FormData(e.target);
            const newPayment = {
                id: Date.now(), // Use timestamp as unique ID
                bookingName: document.getElementById('bookingName').value,
                phoneNumber: document.getElementById('phoneNumber').value,
                paymentMode: document.getElementById('paymentMode').value,
                receivedBy: document.getElementById('receivedBy').value,
                amountAdvance: parseInt(document.getElementById('amountAdvance').value),
                bookingDate: document.getElementById('bookingDate').value,
                dateOfPayment: document.getElementById('dateOfPayment').value,
                property: document.getElementById('property').value
            };

            // Show loading message
            const loadingMsg = document.createElement('div');
            loadingMsg.className = 'fixed top-4 right-4 bg-blue-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 fade-in';
            loadingMsg.textContent = 'Saving to Google Sheets...';
            document.body.appendChild(loadingMsg);

            // Try to save to Google Sheets
            const savedToSheets = await savePaymentToSheets(newPayment);

            // Add to local array regardless
            payments.push(newPayment);
            renderCalendar();
            updatePaymentSummary();
            closeEntryModal();

            // Remove loading message
            loadingMsg.remove();

            // Show success message
            const successMsg = document.createElement('div');
            successMsg.className = `fixed top-4 right-4 ${savedToSheets ? 'bg-green-500' : 'bg-orange-500'} text-white px-6 py-3 rounded-lg shadow-lg z-50 fade-in`;
            successMsg.textContent = savedToSheets ?
                'Payment saved to Google Sheets!' :
                'Payment saved locally (offline mode)';
            document.body.appendChild(successMsg);

            setTimeout(() => {
                successMsg.remove();
            }, 3000);
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96f2ca46546c9368',t:'MTc1NTE5OTAyMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
